<!DOCTYPE html>
<html lang="es-CL">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Manejo de sesión privada con OIDC | Documentacion Front End</title>
    <meta name="description" content="Bienvenido al centro de documentos Front End de Modyo">
    <link rel="apple-touch-icon" sizes="180x180" href="/front-docs/apple-touch-icon.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/front-docs/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/front-docs/favicon-16x16.png">
  <link rel="manifest" href="/front-docs/site.webmanifest">
  <link rel="mask-icon" href="/front-docs/safari-pinned-tab.svg" color="#5bbad5">
  <meta name="apple-mobile-web-app-title" content="Modyo">
  <meta name="application-name" content="Modyo">
  <meta name="theme-color" content="#ffffff">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="#ffffff">
  <meta name="msapplication-TileImage" content="/mstile-150x150.png">
  <meta name="msapplication-TileColor" content="#da532c">
    
    <link rel="preload" href="/front-docs/assets/css/0.styles.8a4b594e.css" as="style"><link rel="preload" href="/front-docs/assets/js/app.8b1797b9.js" as="script"><link rel="preload" href="/front-docs/assets/js/2.e9667b33.js" as="script"><link rel="preload" href="/front-docs/assets/js/10.2965d40b.js" as="script"><link rel="preload" href="/front-docs/assets/js/3.55cf4934.js" as="script"><link rel="prefetch" href="/front-docs/assets/js/11.3c261822.js"><link rel="prefetch" href="/front-docs/assets/js/12.091fd555.js"><link rel="prefetch" href="/front-docs/assets/js/4.8c0208bb.js"><link rel="prefetch" href="/front-docs/assets/js/5.f49bb34d.js"><link rel="prefetch" href="/front-docs/assets/js/6.c278a211.js"><link rel="prefetch" href="/front-docs/assets/js/7.e2f05d14.js"><link rel="prefetch" href="/front-docs/assets/js/8.6b8d2bef.js"><link rel="prefetch" href="/front-docs/assets/js/9.176d7691.js">
    <link rel="stylesheet" href="/front-docs/assets/css/0.styles.8a4b594e.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/front-docs/" class="home-link router-link-active"><img src="/front-docs/assets/img/modyo.png" alt="Documentacion Front End" class="logo"> <span class="site-name can-hide">Documentacion Front End</span></a> <div class="links"><!----> <nav class="nav-links can-hide"><div class="nav-item"><a href="/front-docs/" class="nav-link">Inicio</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Seleccione idioma" class="dropdown-title"><span class="title">Idiomas</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/front-docs/integrations/OIDC/" class="nav-link router-link-exact-active router-link-active">Español</a></li><li class="dropdown-item"><!----> <a href="/front-docs/en/integrations/OIDC/" class="nav-link">English</a></li></ul></div></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/front-docs/" class="nav-link">Inicio</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Seleccione idioma" class="dropdown-title"><span class="title">Idiomas</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/front-docs/integrations/OIDC/" class="nav-link router-link-exact-active router-link-active">Español</a></li><li class="dropdown-item"><!----> <a href="/front-docs/en/integrations/OIDC/" class="nav-link">English</a></li></ul></div></div> <!----></nav>  <ul class="sidebar-links"><li><a href="/front-docs/integrations/" class="sidebar-link">Integrations</a></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>Artículos</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/front-docs/integrations/OIDC/" class="active sidebar-link">Manejo de sesión privada con OIDC</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/front-docs/integrations/OIDC/#hacer-el-sitio-privado" class="sidebar-link">Hacer el sitio privado</a></li><li class="sidebar-sub-header"><a href="/front-docs/integrations/OIDC/#habilitar-la-integracion-a-nivel-de-cuenta-para-todos-los-sitios" class="sidebar-link">Habilitar la integración a nivel de cuenta (para todos los sitios)</a></li><li class="sidebar-sub-header"><a href="/front-docs/integrations/OIDC/#usando-axios-para-hacer-la-integracion" class="sidebar-link">Usando Axios para hacer la integración</a></li><li class="sidebar-sub-header"><a href="/front-docs/integrations/OIDC/#interceptar-los-request-para-que-incluyan-un-token" class="sidebar-link">Interceptar los request para que incluyan un token</a></li><li class="sidebar-sub-header"><a href="/front-docs/integrations/OIDC/#un-controlador-de-sesiones" class="sidebar-link">Un controlador de sesiones</a></li><li class="sidebar-sub-header"><a href="/front-docs/integrations/OIDC/#una-ventana-modal-que-informe-al-usuario-que-su-sesion-va-a-expirar" class="sidebar-link">Una ventana modal que informe al usuario que su sesión va a expirar</a></li></ul></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="manejo-de-sesion-privada-usando-openid-connect-oidc"><a href="#manejo-de-sesion-privada-usando-openid-connect-oidc" class="header-anchor">#</a> Manejo de sesión privada usando OpenID Connect (OIDC)</h1> <p>El método recomendado para interactuar con una API privada usando la sesión de Modyo con una integración OIDC, consiste, básicamente de dos pasos: <strong>hacer el sitio privado</strong> y <strong>habilitar la integración a nivel de cuenta</strong>.</p> <h2 id="hacer-el-sitio-privado"><a href="#hacer-el-sitio-privado" class="header-anchor">#</a> Hacer el sitio privado</h2> <ol><li>Inicia sesión en la cuenta dónde se desea crear el sitio privado.</li> <li>Haz click en crear un nuevo sitio.</li> <li>Asigna un nombre al nuevo sitio y selecciona el tema base.</li> <li>En la sección <code>configuración &gt; sitio</code>, bajo la pestaña <strong>Restricciones</strong>, seleccionamos <strong>privado</strong>. Además activa <strong>Mostrar home a visitas públicas</strong> para poder redireccionar usuarios sin sesión.</li></ol> <h2 id="habilitar-la-integracion-a-nivel-de-cuenta-para-todos-los-sitios"><a href="#habilitar-la-integracion-a-nivel-de-cuenta-para-todos-los-sitios" class="header-anchor">#</a> Habilitar la integración a nivel de cuenta (para todos los sitios)</h2> <ol><li>Ve a la cuenta, <strong>Customers</strong> y desde ahí a la sección <strong>Configuración</strong> y luego la pestaña <strong>Integración</strong></li> <li>Selecciona la integración OpenID Connect y activa la casilla de <strong>Habilitar OpenID Connect</strong></li> <li>Llena los datos de <strong>Nombre del servicio, Client ID, Secret e Issuer</strong> y haz click en <strong>Lanzar servicio de descubrimiento</strong></li> <li>Chequea los campos que necesites (Habilitar refresh token, Habilitar cierre de sesión remoto, Habilitar revocación de token, Habilitar sincronización de claims)</li> <li>Asocia los campos del proveedor con los campos personalizados que tengas en Modyo <a href="http://openid.net/specs/openid-connect-core-1_0.html#StandardClaims" target="_blank" rel="noopener noreferrer">OpenID Connect 1.0 specification for Standard Claims<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li></ol> <h2 id="usando-axios-para-hacer-la-integracion"><a href="#usando-axios-para-hacer-la-integracion" class="header-anchor">#</a> Usando Axios para hacer la integración</h2> <p>Si quieres usar una librería como <code>axios</code> para realizar una integración desde Modyo, un patrón que resulta conveniente es crear 3 snippets que se hagan cargo de los aspectos más básicas de una integración.</p> <p>Las tareas que debes cubrir con los snippets son:</p> <ol><li>Un interceptor de requests para incluyan un token.</li> <li>Un controlador de sesiones.</li> <li>Una ventana modal que informe al usuario que su sesión va a expirar.</li></ol> <h2 id="interceptar-los-request-para-que-incluyan-un-token"><a href="#interceptar-los-request-para-que-incluyan-un-token" class="header-anchor">#</a> Interceptar los request para que incluyan un token</h2> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// variable global que representara una instancia de axios que se encargará de hacer las peticiones de los servicios</span>
<span class="token keyword">var</span> axios_api <span class="token operator">=</span> axios<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  axios_api<span class="token punctuation">.</span>defaults<span class="token punctuation">.</span>baseURL <span class="token operator">=</span> <span class="token string">'URL DE API'</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">// variable global que representara una instancia de axios que se encargará de hacer las peticiones de la api de modyo</span>
<span class="token keyword">var</span> axios_modyo<span class="token operator">=</span>axios<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  baseURL<span class="token punctuation">:</span> window<span class="token punctuation">.</span>baseUrl <span class="token operator">+</span> <span class="token string">'/api/v1'</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// variable global que representara una instancia de axios que se encargará de hacer las peticiones los json de contenido del sitio</span>
<span class="token keyword">var</span> axios_modyo_json<span class="token operator">=</span>axios<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  baseURL<span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token punctuation">{</span>site<span class="token punctuation">.</span>url<span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// variable global que representara una instancia de axios que se encargará de hacer las peticiones relacionadas con la autenticación</span>
<span class="token keyword">var</span> axios_auth <span class="token operator">=</span> axios<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
axios_auth<span class="token punctuation">.</span>defaults<span class="token punctuation">.</span>baseURL <span class="token operator">=</span> window<span class="token punctuation">.</span>baseUrl <span class="token operator">+</span> <span class="token string">'/auth/openidc'</span><span class="token punctuation">;</span>
<span class="token comment">// función que genera actividad en el sitio con cada petición de autenticación</span>
<span class="token keyword">var</span> <span class="token function-variable function">resetIdleTime</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">request</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
  sessionManager<span class="token punctuation">.</span><span class="token function">resetIdleTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">return</span> request<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">// función que agrega el token a cada uno de los request</span>
<span class="token keyword">var</span> <span class="token function-variable function">appendTokenToRequest</span><span class="token operator">=</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">request</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">return</span> axios_auth<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'/access_token'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">response</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
		request<span class="token punctuation">.</span>headers<span class="token punctuation">.</span>authorization<span class="token operator">=</span><span class="token string">'Bearer '</span><span class="token operator">+</span> response<span class="token punctuation">.</span>data<span class="token punctuation">.</span>access_token<span class="token punctuation">;</span>
		<span class="token keyword">return</span> request<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token comment">// función que maneja los errores de cada una de las peticiones y los envía a una instancia superior</span>
<span class="token keyword">var</span> <span class="token function-variable function">errorRequest</span><span class="token operator">=</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">error</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
  <span class="token keyword">throw</span> error<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
axios_auth<span class="token punctuation">.</span>interceptors<span class="token punctuation">.</span>request<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>resetIdleTime<span class="token punctuation">)</span><span class="token punctuation">;</span>
axios_api<span class="token punctuation">.</span>interceptors<span class="token punctuation">.</span>request<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>appendTokenToRequest <span class="token punctuation">,</span>errorRequest<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h2 id="un-controlador-de-sesiones"><a href="#un-controlador-de-sesiones" class="header-anchor">#</a> Un controlador de sesiones</h2> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// se encargará de levantar el modal de advertencia que avisara el cierre próximo de la sesión, esta variable devolverá una promesa que será efectiva si se hace click en el botón Mantener Sesión y que lanzara una promesa reject en el caso de seleccionar el botón con la negativa de continuar</span>
<span class="token keyword">var</span> <span class="token function-variable function">modalConfirm</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">$</span><span class="token punctuation">(</span><span class="token string">&quot;#session-modal&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">modal</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      backdrop<span class="token punctuation">:</span> <span class="token string">&quot;static&quot;</span><span class="token punctuation">,</span>
      keyboard<span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
      show<span class="token punctuation">:</span> <span class="token boolean">true</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">$</span><span class="token punctuation">(</span><span class="token string">&quot;#session-modal-yes&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">&quot;click&quot;</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token string">&quot;keep session&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">$</span><span class="token punctuation">(</span><span class="token string">&quot;#session-modal&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">modal</span><span class="token punctuation">(</span><span class="token string">&quot;hide&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">$</span><span class="token punctuation">(</span><span class="token string">&quot;#session-modal-no&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">&quot;click&quot;</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">reject</span><span class="token punctuation">(</span><span class="token string">&quot;destroy session&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">$</span><span class="token punctuation">(</span><span class="token string">&quot;#session-modal&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">modal</span><span class="token punctuation">(</span><span class="token string">&quot;hide&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token comment">// será la que se encargara de al iniciarse comenzar el tracking del tiempo para levantar este modal y manejar del lado Front la sesión a continuación explicaremos cada uno de las propiedades y métodos de este objeto que maneja la sesión</span>
<span class="token keyword">var</span> sessionManager <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token comment">// propiedad que define el tiempo desde la ultima actividad hasta el fin de la sesión en segundos (ojo no el tiempo de refresco del token sino el de finalización de la sesión, es recomendado que este sea un minuto menor al declarado por el provider del Open ID Connect para tener un poco de holgura con la sesión y el cierre de la misma sea 100% valido)</span>
  timeToEndSessionInSeconds<span class="token punctuation">:</span> <span class="token number">900</span><span class="token punctuation">,</span>
  <span class="token comment">// propiedad donde se define el tiempo de levantamiento del modal de inactividad desde la ultima acción o petición en la pagina</span>
  timeToRaiseWarningModalInSeconds<span class="token punctuation">:</span> <span class="token number">720</span><span class="token punctuation">,</span>
  <span class="token comment">// propiedad que guarda el timestamp del ultimo momento de actividad del sessionManager</span>
  lastActionTimeInThisWindow<span class="token punctuation">:</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token comment">// función que convierte segundos a milisegundos</span>
  <span class="token function-variable function">secondsToMilisecs</span><span class="token punctuation">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">minutes</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> minutes <span class="token operator">*</span> <span class="token number">1000</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token comment">// propiedad para almacenar el interval id de revision de eventos de sesion</span>
  intevalId<span class="token punctuation">:</span><span class="token keyword">null</span><span class="token punctuation">,</span>
  <span class="token comment">// función que determina si se esta accediendo a la aplicación desde el modyoShell o no</span>
  <span class="token function-variable function">isModyoAppShell</span><span class="token punctuation">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token operator">/</span><span class="token punctuation">;</span> Modyo_App_Shell<span class="token operator">/</span><span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span>navigator<span class="token punctuation">.</span>userAgent<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token comment">// método que debe ser ejecutado en cada carga de pagina para comenzar el proceso de eventos de sesión a hacer seguimiento recomendado hacer esta invocación sessionManager.init() en el head del layout para comenzar a trackear la sesión (en algunos casos se definirá que los developers no lancen esta invocación en ese caso la api de prueba a conectarnos debe tener también este if y así lograremos que axios_api sirva para el entorno develop y el de desarrollo uno con sesión y el otro sin sesión manager)</span>
  <span class="token function-variable function">init</span><span class="token punctuation">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">resetIdleTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>intevalId<span class="token operator">=</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">interval</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token comment">// reinicia el tiempo de espera o crea una nueva actividad en el sitio</span>
  <span class="token function-variable function">resetIdleTime</span><span class="token punctuation">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>lastActionTimeInThisWindow <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">var</span> sessionEndTime <span class="token operator">=</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>lastActionTimeInThisWindow <span class="token operator">+</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">secondsToMilisecs</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>timeToEndSessionInSeconds<span class="token punctuation">)</span><span class="token punctuation">;</span>
    localStorage<span class="token punctuation">.</span><span class="token function">setItem</span><span class="token punctuation">(</span><span class="token string">&quot;timeToEndSession&quot;</span><span class="token punctuation">,</span> sessionEndTime<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">var</span> raiseWarningModalTime <span class="token operator">=</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>lastActionTimeInThisWindow <span class="token operator">+</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">secondsToMilisecs</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>timeToRaiseWarningModalInSeconds<span class="token punctuation">)</span><span class="token punctuation">;</span>
    localStorage<span class="token punctuation">.</span><span class="token function">setItem</span><span class="token punctuation">(</span><span class="token string">&quot;timeToRaiseWarningModal&quot;</span><span class="token punctuation">,</span> raiseWarningModalTime<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token comment">// método que inicia la actividad cada segundo js que manejara los eventos de sesión</span>
  <span class="token function-variable function">interval</span><span class="token punctuation">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> self <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token function">setInterval</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>checkSessionEvents<span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">,</span> self<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token comment">// método que levanta el modal de warning time</span>
  <span class="token function-variable function">raiseModal</span><span class="token punctuation">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token function">modalConfirm</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token comment">// método que cierra sesión y limpia storage</span>
  <span class="token function-variable function">logout</span><span class="token punctuation">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    localStorage<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    sessionStorage<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">clearInterval</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>intevalId<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">var</span> withRedirect <span class="token operator">=</span>
      arguments<span class="token punctuation">.</span>length <span class="token operator">&gt;</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> arguments<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">!==</span> <span class="token keyword">undefined</span> <span class="token operator">?</span> arguments<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>withRedirect<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      window<span class="token punctuation">.</span>location<span class="token punctuation">.</span>href <span class="token operator">=</span>
        <span class="token string">&quot;{{site.account_url}}/logout?multi=true&amp;redirect_to=https://chile.larrainvial.com&quot;</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      window<span class="token punctuation">.</span>location<span class="token punctuation">.</span>href <span class="token operator">=</span> <span class="token string">&quot;{{site.account_url}}/logout?site={{site.uuid}}&quot;</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token comment">// método que revisa los eventos de sesión para determinar si es momento de cierre de la misma o de mantenerla después de mostrar el modal</span>
  <span class="token function-variable function">checkSessionEvents</span><span class="token punctuation">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">self</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> sessionEndTime <span class="token operator">=</span> localStorage<span class="token punctuation">.</span><span class="token function">getItem</span><span class="token punctuation">(</span><span class="token string">&quot;timeToEndSession&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">var</span> raiseWarningModalTime <span class="token operator">=</span> localStorage<span class="token punctuation">.</span><span class="token function">getItem</span><span class="token punctuation">(</span><span class="token string">&quot;timeToRaiseWarningModal&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">var</span> diffInSecsToShow <span class="token operator">=</span>
      Math<span class="token punctuation">.</span><span class="token function">round</span><span class="token punctuation">(</span><span class="token punctuation">(</span>sessionEndTime <span class="token operator">-</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">1000</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">0</span>
        <span class="token operator">?</span> Math<span class="token punctuation">.</span><span class="token function">round</span><span class="token punctuation">(</span><span class="token punctuation">(</span>sessionEndTime <span class="token operator">-</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">1000</span><span class="token punctuation">)</span>
        <span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">var</span> expirationTimeHtml <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span><span class="token string">&quot;#expiration-time&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">var</span> timeNow <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    expirationTimeHtml<span class="token punctuation">.</span>innerText <span class="token operator">=</span> diffInSecsToShow<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>sessionEndTime <span class="token operator">-</span> timeNow <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      self<span class="token punctuation">.</span><span class="token function">logout</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>raiseWarningModalTime <span class="token operator">-</span> timeNow <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      self
        <span class="token punctuation">.</span><span class="token function">raiseModal</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">response</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          axios_auth<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;/access_token&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">err</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          self<span class="token punctuation">.</span><span class="token function">logout</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token function">$</span><span class="token punctuation">(</span><span class="token string">&quot;#session-modal&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">data</span><span class="token punctuation">(</span><span class="token string">&quot;bs.modal&quot;</span><span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span>_isShown<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">$</span><span class="token punctuation">(</span><span class="token string">&quot;#session-modal&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">modal</span><span class="token punctuation">(</span><span class="token string">&quot;hide&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><h2 id="una-ventana-modal-que-informe-al-usuario-que-su-sesion-va-a-expirar"><a href="#una-ventana-modal-que-informe-al-usuario-que-su-sesion-va-a-expirar" class="header-anchor">#</a> Una ventana modal que informe al usuario que su sesión va a expirar</h2> <p>Este seria el modal a activar en el paso anterior con bootstrap para el manejo del warning modal.</p> <div class="language-html extra-class"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span>
  <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>session-modal<span class="token punctuation">&quot;</span></span>
  <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>modal fade<span class="token punctuation">&quot;</span></span>
  <span class="token attr-name">tabindex</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>-1<span class="token punctuation">&quot;</span></span>
  <span class="token attr-name">role</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>dialog<span class="token punctuation">&quot;</span></span>
  <span class="token attr-name">aria-labelledby</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>session-modal-label<span class="token punctuation">&quot;</span></span>
<span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>modal-dialog<span class="token punctuation">&quot;</span></span> <span class="token attr-name">role</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>document<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>modal-content<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>modal-header<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h5</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>modal-title<span class="token punctuation">&quot;</span></span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>session-modal-label<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
          Su sesión va a expirar
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h5</span><span class="token punctuation">&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>modal-body text-center<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span><span class="token punctuation">&gt;</span></span>
          Su sesión va a expirar en <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>span</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>expiration-time<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>span</span><span class="token punctuation">&gt;</span></span> segundos.
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span><span class="token punctuation">&gt;</span></span>¿Quiere mantener su sesión?<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>modal-footer<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>button</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>session-modal-yes<span class="token punctuation">&quot;</span></span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>button<span class="token punctuation">&quot;</span></span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>btn btn-primary<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
          Si
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>button</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>button</span>
          <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>session-modal-no<span class="token punctuation">&quot;</span></span>
          <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>button<span class="token punctuation">&quot;</span></span>
          <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>btn btn-secondary<span class="token punctuation">&quot;</span></span>
          <span class="token attr-name">data-dismiss</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>modal<span class="token punctuation">&quot;</span></span>
        <span class="token punctuation">&gt;</span></span>
          No
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>button</span><span class="token punctuation">&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
</code></pre></div></div> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">Última Actualización:</span> <span class="time">12/4/2019, 5:52:34 PM</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/front-docs/integrations/" class="prev router-link-active">Integrations</a></span> <!----></p></div> </main></div><div class="global-ui"><!----><!----></div></div>
    <script src="/front-docs/assets/js/app.8b1797b9.js" defer></script><script src="/front-docs/assets/js/2.e9667b33.js" defer></script><script src="/front-docs/assets/js/10.2965d40b.js" defer></script><script src="/front-docs/assets/js/3.55cf4934.js" defer></script>
  </body>
</html>
